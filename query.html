<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<title>Query Students</title>
<style>
.selected { background-color: #ffe4b5; }
</style>
</head>
<body>
<div class="container">
  <h1>Query Student Records</h1>
  
  <div class="actions">
    <input type="text" id="filterName" placeholder="Filter by Name">
    <button onclick="queryData()">Search</button>
    <button onclick="queryData(true)">All Records</button>
    <button id="deleteBtn" onclick="deleteSelected()" disabled>??? Delete Selected</button>
  </div>
  
  <table id="results">
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Year</th><th>BoxNo</th><th>Seq</th>
        <th>Contact No</th><th>Cond Detl</th><th>File State</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <a href="index.html">? Add New Record</a>
</div>

<script>
let selectedId = null;

// Fetch and render data
async function queryData(all=false) {
  const name = document.getElementById('filterName').value;
  const query = all ? '/query' : `/query?name=${name}`;
  const res = await fetch(query);
  const rows = await res.json();
  const tbody = document.querySelector('#results tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.name}</td>
      <td>${r.year}</td>
      <td>${r.boxno}</td>
      <td>${r.seq}</td>
      <td>${r.contno}</td>
      <td>${r.condetl}</td>
      <td>${r.filestate}</td>`;
    tr.onclick = () => selectRow(tr, r.id);
    tbody.appendChild(tr);
  });
  selectedId = null;
  document.getElementById('deleteBtn').disabled = true;
}

function selectRow(tr, id) {
  document.querySelectorAll('#results tr').forEach(row => row.classList.remove('selected'));
  tr.classList.add('selected');
  selectedId = id;
  document.getElementById('deleteBtn').disabled = false;
}

async function deleteSelected() {
  if (!selectedId) return alert('Please select a record first.');
  if (!confirm('Are you sure you want to delete this record?')) return;
  const res = await fetch(`/delete/${selectedId}`, { method: 'DELETE' });
  const result = await res.json();
  if (result.deleted) {
    alert('Record deleted successfully!');
    queryData(true);
  } else {
    alert('Delete failed!');
  }
}
</script>
</body>
</html>